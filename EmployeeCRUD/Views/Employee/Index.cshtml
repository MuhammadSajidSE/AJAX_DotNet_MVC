@model IEnumerable<EmployeeCRUD.Models.Employee>
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <title>Employee CRUD AJAX</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .form-control:invalid {
            border-color: #dc3545;
        }
    </style>
</head>

<body class="container mt-4">

    <div class="card">
        <div class="card-header">
            <h3 id="formTitle">Add Employee</h3>
        </div>
        <div class="card-body">
            <form id="employeeForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="empId" value="0" />

                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Name</label>
                        <input class="form-control" name="name" id="name" required />
                        <div class="invalid-feedback">Please enter a name.</div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Contact</label>
                        <input class="form-control" name="contact" id="contact" required />
                        <div class="invalid-feedback">Please enter contact information.</div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Department</label>
                        <input class="form-control" name="department" id="department" required />
                        <div class="invalid-feedback">Please enter a department.</div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Gender</label>
                        <select class="form-select" name="Gender" id="Gender" required>
                            <option value="">-- Select Gender --</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                        <div class="invalid-feedback">Please select a gender.</div>
                    </div>
                </div>

                <div class="mt-3">
                    <button type="submit" id="submitBtn" class="btn btn-success">
                        Add Employee
                    </button>
                    <button type="button" id="resetBtn" class="btn btn-secondary">
                        Reset Form
                    </button>
                </div>
            </form>
        </div>
    </div>

    <hr>

    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" id="searchBox" class="form-control" placeholder="Search by name">
        </div>
        <div class="col-md-6 text-end">
            <button id="resetSearchBtn" class="btn btn-outline-secondary">
                Reset Search
            </button>
        </div>
    </div>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Contact</th>
                <th>Dept</th>
                <th>Gender</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="employeeTableBody">
            @foreach (var e in Model)
            {
                <tr id="emp_@e.id">
                    <td>@e.id</td>
                    <td>@e.name</td>
                    <td>@e.contact</td>
                    <td>@e.department</td>
                    <td>@e.Gender</td>
                    <td>
                        <button class="btn btn-sm btn-primary editBtn" data-id="@e.id">Edit</button>
                        <button class="btn btn-sm btn-danger deleteBtn" data-id="@e.id">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <script>
        $(function () {
            // Get anti-forgery token
            var token = $('input[name="__RequestVerificationToken"]').val();

            // Validate form before submission
            function validateForm() {
                let isValid = true;
                $('#employeeForm').find('input[required], select[required]').each(function() {
                    if (!$(this).val().trim()) {
                        $(this).addClass('is-invalid');
                        isValid = false;
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                });
                return isValid;
            }

            // Reset form validation
            function resetFormValidation() {
                $('#employeeForm').find('input, select').removeClass('is-invalid');
            }

            // ADD / UPDATE
            $("#employeeForm").submit(function (e) {
                e.preventDefault();

                if (!validateForm()) {
                    alert("Please fill in all required fields.");
                    return;
                }

                var id = $("#empId").val();
                var url = id && id != "0" ? "/Employee/Edit" : "/Employee/Add";
                var method = "POST";

                $.ajax({
                    url: url,
                    type: method,
                    data: $(this).serialize(),
                    headers: {
                        'RequestVerificationToken': token
                    },
                    success: function (emp) {
                        if (!id || id == "0") {
                            // Add new employee
                            $("#employeeTableBody").append(`
                                <tr id="emp_${emp.id}">
                                    <td>${emp.id}</td>
                                    <td>${emp.name}</td>
                                    <td>${emp.contact}</td>
                                    <td>${emp.department}</td>
                                    <td>${emp.gender}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary editBtn" data-id="${emp.id}">Edit</button>
                                        <button class="btn btn-sm btn-danger deleteBtn" data-id="${emp.id}">Delete</button>
                                    </td>
                                </tr>
                            `);
                        } else {
                            // Update existing employee
                            var row = $("#emp_" + emp.id);
                            row.find("td:eq(1)").text(emp.name);
                            row.find("td:eq(2)").text(emp.contact);
                            row.find("td:eq(3)").text(emp.department);
                            row.find("td:eq(4)").text(emp.gender);
                        }

                        resetForm();
                        showSuccessMessage(id ? "Employee updated successfully!" : "Employee added successfully!");
                    },
                    error: function (xhr) {
                        if (xhr.status === 400) {
                            alert("Validation Error: " + xhr.responseText);
                        } else {
                            alert("An error occurred: " + xhr.statusText);
                        }
                    }
                });
            });

            // Reset form function
            function resetForm() {
                $("#employeeForm")[0].reset();
                $("#empId").val("0");
                $("#submitBtn").text("Add Employee");
                $("#formTitle").text("Add Employee");
                resetFormValidation();
            }

            // EDIT
            $(document).on("click", ".editBtn", function () {
                var employeeId = $(this).data("id");
                $.get("/Employee/Get", { id: employeeId }, function (emp) {
                    if (emp) {
                        $("#empId").val(emp.id);
                        $("#name").val(emp.name);
                        $("#contact").val(emp.contact);
                        $("#department").val(emp.department);
                        $("#Gender").val(emp.gender);
                        $("#submitBtn").text("Update Employee");
                        $("#formTitle").text("Edit Employee");
                        resetFormValidation();
                    }
                }).fail(function() {
                    alert("Error loading employee data.");
                });
            });

            // DELETE
            $(document).on("click", ".deleteBtn", function () {
                if (!confirm("Are you sure you want to delete this employee?")) return;

                let id = $(this).data("id");
                $.ajax({
                    url: "/Employee/Delete",
                    type: "POST",
                    data: { id: id },
                    headers: {
                        'RequestVerificationToken': token
                    },
                    success: function () {
                        $("#emp_" + id).remove();
                        showSuccessMessage("Employee deleted successfully!");
                    },
                    error: function (xhr) {
                        alert("Error deleting employee: " + xhr.statusText);
                    }
                });
            });

            // SEARCH
            $("#searchBox").on("keyup", function () {
                var searchTerm = $(this).val().trim();

                if (searchTerm.length === 0) {
                    loadAllEmployees();
                    return;
                }

                $.get("/Employee/Search", { q: searchTerm }, function (data) {
                    renderEmployeeTable(data);
                }).fail(function() {
                    alert("Error searching employees.");
                });
            });

            // Reset search
            $("#resetSearchBtn").click(function() {
                $("#searchBox").val("");
                loadAllEmployees();
            });

            // Reset form button
            $("#resetBtn").click(function() {
                resetForm();
            });

            // Helper function to render employee table
            function renderEmployeeTable(data) {
                let rows = "";
                if (data.length > 0) {
                    $.each(data, function (_, e) {
                        rows += `
                            <tr id="emp_${e.id}">
                                <td>${e.id}</td>
                                <td>${e.name}</td>
                                <td>${e.contact}</td>
                                <td>${e.department}</td>
                                <td>${e.gender}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary editBtn" data-id="${e.id}">Edit</button>
                                    <button class="btn btn-sm btn-danger deleteBtn" data-id="${e.id}">Delete</button>
                                </td>
                            </tr>`;
                    });
                } else {
                    rows = `<tr><td colspan="6" class="text-center">No employees found</td></tr>`;
                }
                $("#employeeTableBody").html(rows);
            }

            // Helper function to load all employees
            function loadAllEmployees() {
                $.get("/Employee/GetAll", function (data) {
                    renderEmployeeTable(data);
                }).fail(function() {
                    alert("Error loading employees.");
                });
            }

            // Helper function to show success message
            function showSuccessMessage(message) {
                // You can implement a toast notification here
                alert(message);
            }

            // Initialize form validation on blur
            $('#employeeForm').find('input[required], select[required]').on('blur', function() {
                if (!$(this).val().trim()) {
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid');
                }
            });
        });
    </script>

</body>
</html>