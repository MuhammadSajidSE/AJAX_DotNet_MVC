@model IEnumerable<EmployeeCRUD.Models.Employee>
@{
    Layout = null;
    // Get departments for dropdown from ViewBag
    var departments = ViewBag.Departments as List<EmployeeCRUD.Models.Department>;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Management System</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <!-- User Info and Logout Button -->
        <div class="row mb-3">
            <div class="col-md-8">
                <div id="userInfo" class="alert alert-info py-2">
                    Welcome, <strong>@ViewBag.FullName</strong>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button id="logoutBtn" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Header Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="mb-0">Employee Management System</h3>
            </div>
        </div>

        <!-- Employee CRUD Card -->
        <div class="card shadow-sm mb-4">
            <div class="card-body p-4">
                <h4 class="card-title mb-4" id="formTitle">Add New Employee</h4>
                <form id="employeeForm" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="empId" value="0" />

                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Name *</label>
                            <input class="form-control" name="name" id="name" required />
                            <div class="invalid-feedback">Please enter a name.</div>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Contact *</label>
                            <input class="form-control" name="contact" id="contact" required />
                            <div class="invalid-feedback">Please enter contact information.</div>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Department *</label>
                            <select class="form-select" name="departmentId" id="departmentId" required>
                                <option value="">-- Select Department --</option>
                                @if (departments != null)
                                {
                                    @foreach (var dept in departments)
                                    {
                                        <option value="@dept.Id">@dept.DeparmentName</option>
                                    }
                                }
                            </select>
                            <div class="invalid-feedback">Please select a department.</div>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">Gender *</label>
                            <select class="form-select" name="Gender" id="Gender" required>
                                <option value="">-- Select Gender --</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                            <div class="invalid-feedback">Please select a gender.</div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <button type="submit" id="submitBtn" class="btn btn-success">
                            <i class="fas fa-plus"></i> Add Employee
                        </button>
                        <button type="button" id="resetBtn" class="btn btn-secondary">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Search Section -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                    <input type="text" id="searchBox" class="form-control" placeholder="Search employees by name...">
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button id="resetSearchBtn" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Clear Search
                </button>
            </div>
        </div>

        <!-- Employees Table -->
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Contact</th>
                        <th>Department</th>
                        <th>Gender</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody">
                    @if (Model != null && Model.Any())
                    {
                        @foreach (var e in Model)
                        {
                            <tr id="emp_@e.id">
                                <td>@e.id</td>
                                <td>@e.name</td>
                                <td>@e.contact</td>
                                <td>@(e.Department?.DeparmentName ?? "N/A")</td>
                                <td>@e.Gender</td>
                                <td>
                                    <button class="btn btn-sm btn-primary editBtn" data-id="@e.id">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-sm btn-danger deleteBtn" data-id="@e.id">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center">No employees found</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {

            // Get the anti-forgery token from the form
            function getToken() {
                return $('input[name="__RequestVerificationToken"]').val();
            }

            // Reset form
            function resetForm() {
                $("#employeeForm")[0].reset();
                $("#empId").val("0");
                $("#submitBtn").html('<i class="fas fa-plus"></i> Add Employee');
                $("#formTitle").text("Add New Employee");
                $("#employeeForm").find('input, select').removeClass('is-invalid');
            }

            // Show success message
            function showSuccessMessage(msg) {
                const alertDiv = $(`<div class="alert alert-success alert-dismissible fade show position-fixed" style="top:20px; right:20px; z-index:9999;">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);
                $('body').append(alertDiv);
                setTimeout(() => { alertDiv.alert('close'); }, 3000);
            }

            // Render employee table
            function renderEmployeeTable(data) {
                let rows = '';
                if (data && data.length > 0) {
                    data.forEach(e => {
                        rows += `<tr id="emp_${e.id}">
                                    <td>${e.id}</td>
                                    <td>${e.name}</td>
                                    <td>${e.contact}</td>
                                    <td>${e.departmentName || 'N/A'}</td>
                                    <td>${e.gender}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary editBtn" data-id="${e.id}"><i class="fas fa-edit"></i> Edit</button>
                                        <button class="btn btn-sm btn-danger deleteBtn" data-id="${e.id}"><i class="fas fa-trash"></i> Delete</button>
                                    </td>
                                </tr>`;
                    });
                } else {
                    rows = `<tr><td colspan="6" class="text-center">No employees found</td></tr>`;
                }
                $("#employeeTableBody").html(rows);
            }

            // Load all employees
            function loadAllEmployees() {
                $.get("/Employee/GetAll", function(data) {
                    renderEmployeeTable(data);
                });
            }

            // Add/Edit employee
            $("#employeeForm").submit(function(e) {
                e.preventDefault();

                // Simple validation
                let valid = true;
                $(this).find('input[required], select[required]').each(function() {
                    if (!$(this).val()) {
                        $(this).addClass('is-invalid');
                        valid = false;
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                });
                if (!valid) {
                    alert("Please fill all required fields.");
                    return;
                }

                const id = $("#empId").val();
                const url = id && id != "0" ? "/Employee/Edit" : "/Employee/Add";

                // Create employee data object
                const employeeData = {
                    id: $("#empId").val(),
                    name: $("#name").val(),
                    contact: $("#contact").val(),
                    departmentId: parseInt($("#departmentId").val()),
                    Gender: $("#Gender").val()
                };

                $.ajax({
                    url: url,
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(employeeData),
                    headers: {
                        'RequestVerificationToken': getToken(),
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    success: function(emp) {
                        if (!id || id == "0") {
                            // Added new employee
                            $("#employeeTableBody").append(`<tr id="emp_${emp.id}">
                                <td>${emp.id}</td>
                                <td>${emp.name}</td>
                                <td>${emp.contact}</td>
                                <td>${emp.departmentName || 'N/A'}</td>
                                <td>${emp.gender}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary editBtn" data-id="${emp.id}"><i class="fas fa-edit"></i> Edit</button>
                                    <button class="btn btn-sm btn-danger deleteBtn" data-id="${emp.id}"><i class="fas fa-trash"></i> Delete</button>
                                </td>
                            </tr>`);
                            showSuccessMessage("Employee added successfully!");
                        } else {
                            // Updated existing employee
                            const row = $("#emp_" + emp.id);
                            row.find("td:eq(1)").text(emp.name);
                            row.find("td:eq(2)").text(emp.contact);
                            row.find("td:eq(3)").text(emp.departmentName || 'N/A');
                            row.find("td:eq(4)").text(emp.gender);
                            showSuccessMessage("Employee updated successfully!");
                        }
                        resetForm();
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = "An error occurred.";
                        try {
                            const errorResponse = JSON.parse(xhr.responseText);
                            errorMessage = errorResponse.message || errorResponse;
                        } catch (e) {
                            errorMessage = xhr.responseText || error;
                        }
                        alert("Error: " + errorMessage);
                    }
                });
            });

            // Edit button
            $(document).on("click", ".editBtn", function() {
                const id = $(this).data("id");
                $.get("/Employee/Get", { id: id }, function(emp) {
                    $("#empId").val(emp.id);
                    $("#name").val(emp.name);
                    $("#contact").val(emp.contact);
                    $("#departmentId").val(emp.departmentId);
                    $("#Gender").val(emp.gender);
                    $("#submitBtn").html('<i class="fas fa-save"></i> Update Employee');
                    $("#formTitle").text("Edit Employee");
                }).fail(function(xhr) {
                    alert("Error loading employee: " + xhr.responseText);
                });
            });

            // Delete button
            $(document).on("click", ".deleteBtn", function() {
                if (!confirm("Are you sure you want to delete this employee?")) return;
                const id = $(this).data("id");
                $.ajax({
                    url: "/Employee/Delete",
                    type: "POST",
                    data: JSON.stringify({ id: id }),
                    contentType: "application/json",
                    headers: { 'RequestVerificationToken': getToken() },
                    success: function() {
                        $("#emp_" + id).remove();
                        showSuccessMessage("Employee deleted successfully!");

                        // If table becomes empty, show no records message
                        if ($("#employeeTableBody tr").length === 0) {
                            $("#employeeTableBody").html('<tr><td colspan="6" class="text-center">No employees found</td></tr>');
                        }
                    },
                    error: function(xhr) {
                        alert("Error deleting employee: " + xhr.responseText);
                    }
                });
            });

            // Search
            $("#searchBox").on("keyup", function() {
                const q = $(this).val().trim();
                if (!q) return loadAllEmployees();
                $.get("/Employee/Search", { q: q }, function(data) {
                    renderEmployeeTable(data);
                }).fail(function(xhr) {
                    alert("Error searching: " + xhr.responseText);
                });
            });

            $("#resetSearchBtn").click(function() {
                $("#searchBox").val("");
                loadAllEmployees();
            });

            $("#resetBtn").click(resetForm);

        $("#logoutBtn").click(function() {
            $.ajax({
                url: "/Account/Logout",
                type: "POST",
                headers: {
                    'RequestVerificationToken': getToken(),
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                success: function() {
                    window.location.href = "/Account/Index";
                },
                error: function(xhr, status, error) {
                    console.error("Logout error:", error);
                    window.location.href = "/Account/Index";
                }
            });
        });

            // Initial load
            loadAllEmployees();
        });
    </script>
</body>
</html>